// DC Academy - LMS Platform
// Schema v1.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS ====================

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

enum UserStatus {
  PENDING
  ACTIVE
  INACTIVE
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  password      String
  name          String
  role          Role       @default(STUDENT)
  status        UserStatus @default(PENDING)
  avatar        String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  enrollments   Enrollment[]
  comments      Comment[]
  ratings       Rating[]
  certificates  Certificate[]
  examAttempts  ExamAttempt[]
  coursesAsTeacher Course[] @relation("TeacherCourses")

  @@index([email])
  @@index([role])
}

// ==================== COURSES ====================

model Category {
  id            String     @id @default(cuid())
  name          String     @unique
  slug          String     @unique
  createdAt     DateTime   @default(now())
  
  subcategories Subcategory[]
  courses       Course[]
}

model Subcategory {
  id          String   @id @default(cuid())
  name        String
  slug        String
  categoryId  String
  createdAt   DateTime @default(now())
  
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  courses     Course[]

  @@unique([categoryId, slug])
}

model Course {
  id                String   @id @default(cuid())
  title             String
  slug              String   @unique
  description       String?
  thumbnail         String?
  categoryId        String
  subcategoryId     String?
  teacherId         String
  durationDays      Int      @default(30) // Max days to complete
  retryWaitDays     Int      @default(7)  // Days to wait before retry
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  category          Category     @relation(fields: [categoryId], references: [id])
  subcategory       Subcategory? @relation(fields: [subcategoryId], references: [id])
  teacher           User         @relation("TeacherCourses", fields: [teacherId], references: [id])
  modules           Module[]
  enrollments       Enrollment[]
  ratings           Rating[]
  certificates      Certificate[]
  
  // Prerequisites
  prerequisites     CoursePrerequisite[] @relation("CourseWithPrereqs")
  isPrerequisiteFor CoursePrerequisite[] @relation("PrerequisiteCourse")

  @@index([categoryId])
  @@index([teacherId])
  @@index([isActive])
}

model CoursePrerequisite {
  id               String @id @default(cuid())
  courseId         String
  prerequisiteId   String
  
  course           Course @relation("CourseWithPrereqs", fields: [courseId], references: [id], onDelete: Cascade)
  prerequisite     Course @relation("PrerequisiteCourse", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@unique([courseId, prerequisiteId])
}

// ==================== MODULES ====================

model Module {
  id            String   @id @default(cuid())
  courseId      String
  title         String
  description   String?
  videoUrl      String?  // Embedded video URL (YouTube, Vimeo, etc.)
  order         Int
  hasExam       Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  course        Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  resources     ModuleResource[]
  exam          Exam?
  comments      Comment[]
  progress      ModuleProgress[]

  @@unique([courseId, order])
  @@index([courseId])
}

model ModuleResource {
  id          String @id @default(cuid())
  moduleId    String
  title       String
  url         String
  type        String // pdf, drive, youtube, external
  order       Int
  
  module      Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
}

// ==================== EXAMS ====================

model Exam {
  id              String   @id @default(cuid())
  moduleId        String   @unique
  passingScore    Int      @default(70) // Percentage
  minutesPerQuestion Int   @default(2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  module          Module        @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  questions       Question[]
  attempts        ExamAttempt[]
}

model Question {
  id          String   @id @default(cuid())
  examId      String
  text        String
  order       Int
  createdAt   DateTime @default(now())

  // Relations
  exam        Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  options     QuestionOption[]
  answers     ExamAnswer[]

  @@index([examId])
}

model QuestionOption {
  id          String   @id @default(cuid())
  questionId  String
  text        String
  isCorrect   Boolean  @default(false)
  order       Int

  // Relations
  question    Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers     ExamAnswer[]

  @@index([questionId])
}

model ExamAttempt {
  id            String   @id @default(cuid())
  examId        String
  userId        String
  enrollmentId  String
  score         Int      // Percentage
  passed        Boolean
  startedAt     DateTime @default(now())
  completedAt   DateTime?

  // Relations
  exam          Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollment    Enrollment   @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  answers       ExamAnswer[]

  @@index([examId])
  @@index([userId])
  @@index([enrollmentId])
}

model ExamAnswer {
  id          String   @id @default(cuid())
  attemptId   String
  questionId  String
  optionId    String?
  isCorrect   Boolean

  // Relations
  attempt     ExamAttempt     @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question    Question        @relation(fields: [questionId], references: [id], onDelete: Cascade)
  option      QuestionOption? @relation(fields: [optionId], references: [id])

  @@index([attemptId])
}

// ==================== ENROLLMENTS & PROGRESS ====================

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  FAILED
}

model Enrollment {
  id            String           @id @default(cuid())
  userId        String
  courseId      String
  status        EnrollmentStatus @default(ACTIVE)
  attemptNumber Int              @default(1)
  startedAt     DateTime         @default(now())
  expiresAt     DateTime
  completedAt   DateTime?

  // Relations
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course        Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  moduleProgress ModuleProgress[]
  examAttempts  ExamAttempt[]
  certificate   Certificate?

  @@unique([userId, courseId, attemptNumber])
  @@index([userId])
  @@index([courseId])
  @@index([status])
}

model ModuleProgress {
  id           String   @id @default(cuid())
  enrollmentId String
  moduleId     String
  completed    Boolean  @default(false)
  examPassed   Boolean?
  completedAt  DateTime?

  // Relations
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  module       Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, moduleId])
  @@index([enrollmentId])
}

// ==================== COMMENTS & RATINGS ====================

model Comment {
  id          String   @id @default(cuid())
  moduleId    String
  userId      String
  parentId    String?  // For replies
  content     String
  isPinned    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  module      Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent      Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies     Comment[] @relation("CommentReplies")

  @@index([moduleId])
  @@index([userId])
}

model Rating {
  id        String   @id @default(cuid())
  courseId  String
  userId    String
  score     Int      // 1-5
  comment   String?
  createdAt DateTime @default(now())

  // Relations
  course    Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
  @@index([courseId])
}

// ==================== CERTIFICATES ====================

model Certificate {
  id            String   @id @default(cuid())
  enrollmentId  String   @unique
  courseId      String
  userId        String
  code          String   @unique // Verification code
  issuedAt      DateTime @default(now())
  pdfUrl        String?

  // Relations
  enrollment    Enrollment @relation(fields: [enrollmentId], references: [id])
  course        Course     @relation(fields: [courseId], references: [id])
  user          User       @relation(fields: [userId], references: [id])

  @@index([code])
  @@index([userId])
}

// ==================== NEWS & AGENDA ====================

model News {
  id          String   @id @default(cuid())
  title       String
  content     String
  imageUrl    String?
  isActive    Boolean  @default(true)
  publishAt   DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, publishAt])
}

model AgendaEvent {
  id          String   @id @default(cuid())
  title       String
  description String?
  date        DateTime
  time        String   // "09:00"
  link        String?
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
}

// ==================== LIVE STREAMING ====================

model LiveConfig {
  id          String   @id @default(cuid())
  title       String
  iframeUrl   String
  isActive    Boolean  @default(false)
  updatedAt   DateTime @updatedAt
}
